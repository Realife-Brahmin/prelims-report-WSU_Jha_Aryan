%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Chapter: Differential Dynamic Programming for MPOPF
% Context: Temporal decomposition via DDP
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\clearpage
\section{Temporal Decomposition via Differential Dynamic Programming}
\label{sec:ddp}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Introduction}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

While the spatial decomposition approach (ENApp) demonstrated in \Cref{sec:enapp} effectively partitions the network topology, it encounters computational challenges for long time horizons due to the temporal coupling through battery state-of-charge (SOC) dynamics. As shown in the previous chapter, spatial decomposition alone remains computationally expensive for planning horizons exceeding 10 hours.

This motivates the investigation of \textbf{temporal decomposition} methods that can break down the multi-period optimization problem across time while maintaining feasibility and near-optimality. One such approach is \textbf{Differential Dynamic Programming (DDP)} \cite{ddp_sugar_01}, which leverages the sequential structure of the MPOPF problem to decompose it into a backward-forward sweep algorithm.

DDP offers several advantages for MPOPF:
\begin{itemize}
    \item \textbf{Temporal Decomposition}: Solves single-period subproblems sequentially
    \item \textbf{Handles Nonlinearity}: Can work with nonlinear branch flow models (BFM-NL) without requiring linearization
    \item \textbf{Scalability}: Computational complexity grows linearly with time horizon length
    \item \textbf{Local Optimality}: Guarantees convergence to local optima through iterative refinement
    \item \textbf{Guaranteed Feasibility always}: At any Forward Pass iteration ensures that its current solution is feasible (provided there are no terminal constraints on state variable such as terminal SOC constraint)
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{DDP Algorithm for MPOPF}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

The DDP algorithm iteratively refines a nominal trajectory through backward-forward sweeps. For MPOPF, the algorithm proceeds as follows:

\subsubsection*{DDP Workflow: Forward Pass for Non-Terminal Time-Step $t \in \{1, 2, \ldots T-1\}$}

At each non-terminal time-step, the forward pass solves the following optimization problem where the previous battery SOC $\textcolor{red}{B_{j}^{t-1}}$ is known from the previous time-step, and the Lagrange multiplier $\textcolor{blue}{\mu_{SOC{_j}}^{t+1}}$ from the next time-step influences the current decision:

\begin{gather}
    \begin{align}
        \min_{} 
        \vspace{-15ex}
        & \quad
        C^t P_{Subs}^t \\
        &+ \alpha \sum_{j \in \mathcal{B}} \left\{ (1- \eta_c)P_{c_j}^t + \left(\frac{1}{\eta_d}-1\right) P_{d_j}^t \right\} \nonumber\\
        &+ \sum_{j \in \mathcal{B}} { \textcolor{blue}{ \mu_{SOC{_j}}^{t+1}} \left\{ - B_{j}^{t} \right\} } \nonumber\\
        \text{s.t.} & {}\nonumber\\
        {0} & = {\sum_{(j, k) \in \mathcal{L}} \left\{P_{jk}^t\right\} - \left\{P_{ij}^t - r_{ij}l_{ij}^t\right\} - (P_{d_j}^t - P_{c_j}^t)  - (p_D{_j}^t) + p_L{_j}^t} && \\
        {0} & = {\sum_{(j, k) \in \mathcal{L}} \left\{Q_{jk}^t\right\} - \left\{Q_{ij}^t - x_{ij}l_{ij}^t\right\} - (q_{D_j}^t) - (q_{B_j}^t) + q_L{_j}^t} && \\
        {0} & = {v_{i}^t - v_{j}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t) + \left\{r_{ij}^2 + x_{ij}^2\right\}l_{ij}^t}  && \\
        {0} & = {(P_{ij}^{t})^2 + (Q_{ij}^{t})^2 - v_{i}^t l_{ij}^t } \\
        {0} & = {B_{j}^{t} - \left\{ \textcolor{red}{ B_{j}^{t-1} } + \Delta t  \eta_c P_{c_j}^t - \Delta t\frac{1}{\eta_d} P_{d_j}^t \right\} } \\
        {0} & \geq {B{_{min_{j}}}^t - B{_j}^t} \\
        {0} & \geq {B{_j}^t - B{_{Max_{j}}}^t} \\
        {0} & \geq {\text{All other inequality constraints}}
    \end{align}
\end{gather}

\subsubsection*{DDP Workflow: Forward Pass for the Terminal Time-Step $t = T$}

At the terminal time-step, the forward pass includes the terminal penalty on battery SOC deviation from reference:

\begin{gather}
    \begin{align}
        \min_{} 
        \vspace{-15ex}
        & \quad
        C^t P_{Subs}^t \\
        &+ \alpha \sum_{j \in \mathcal{B}} \left\{ (1- \eta_c)P_{c_j}^t + \left(\frac{1}{\eta_d}-1\right) P_{d_j}^t \right\} \nonumber\\
        &+ \gamma \sum_{j \in \mathcal{B}} \left\{ \left(B^{T}_{j} - B_{ref_{j}}\right)^2\right\} \nonumber\\
        \text{s.t.} & {}\nonumber\\
        {0} & = {\sum_{(j, k) \in \mathcal{L}} \left\{P_{jk}^t\right\} - \left\{P_{ij}^t - r_{ij}l_{ij}^t\right\} - (P_{d_j}^t - P_{c_j}^t)  - (p_D{_j}^t) + p_L{_j}^t} && \\
        {0} & = {\sum_{(j, k) \in \mathcal{L}} \left\{Q_{jk}^t\right\} - \left\{Q_{ij}^t - x_{ij}l_{ij}^t\right\} - (q_{D_j}^t) - (q_{B_j}^t) + q_L{_j}^t} && \\
        {0} & = {v_{i}^t - v_{j}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t) + \left\{r_{ij}^2 + x_{ij}^2\right\}l_{ij}^t}  && \\
        {0} & = {(P_{ij}^{t})^2 + (Q_{ij}^{t})^2 - v_{i}^t l_{ij}^t } \\
        {0} & = {B_{j}^{t} - \left\{ \textcolor{red}{ B_{j}^{t-1} } + \Delta t  \eta_c P_{c_j}^t - \Delta t\frac{1}{\eta_d} P_{d_j}^t \right\} } \\
        {0} & \geq {B{_{min_{j}}}^t - B{_j}^t} \\
        {0} & \geq {B{_j}^t - B{_{Max_{j}}}^t} \\
        {0} & \geq {\text{All other inequality constraints}}
    \end{align}
\end{gather}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Computational Advantages for Long-Horizon MPOPF}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

DDP offers significant computational benefits compared to monolithic MPOPF formulations:

\begin{enumerate}        
    \item \textbf{Parallelizable Forward Pass}: Subproblems within forward pass can be solved in parallel across time steps.
    
    \item \textbf{Handles Nonlinearity}: Works directly with BFM-NL \cite{Farivar1} without requiring convex relaxations or linear approximations that may sacrifice accuracy.
    
    \item \textbf{Warm Starting}: Previous solutions provide excellent initialization for rolling-horizon Model Predictive Control (MPC) implementations.
\end{enumerate}

For a 24-hour horizon with 15-minute resolution ($N=96$), 123-bus system (IEEE 123), and 30 batteries, DDP reduces the problem from jointly optimizing $\sim$10,000 variables to solving 96 sequential subproblems each with $\sim$100 variables.


For MPOPF, the projection approach is most practical, as it maintains power flow feasibility explicitly.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Relationship to Other Decomposition Methods}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

DDP provides complementary capabilities to the spatial decomposition (ENApp, \Cref{sec:enapp}):

\begin{itemize}
    \item \textbf{ENApp}: Decomposes across \textit{space} (network topology), coupling through boundary voltage and power variables
    \item \textbf{DDP}: Decomposes across \textit{time} (temporal horizon), coupling through battery SOC evolution
    \item \textbf{Combined Approach}: Apply spatial decomposition (ENApp) within each DDP time-step subproblem, achieving both spatial and temporal scalability
\end{itemize}

Compared to ADMM-based temporal decomposition (next chapter):
\begin{itemize}
    \item \textbf{DDP}: Sequential backward-forward sweeps, local convergence to stationary points, guaranteed feasible solution at any stage of the algorithm
    \item \textbf{tADMM}: Parallel consensus-based optimization, handles separable structure, global convergence guarantees for convex problems, no guarantee of feasible solution at any current algorithm stage
    \item \textbf{Trade-off}: DDP more efficient for few iterations (warm start), ADMM more parallelizable for cold start
\end{itemize}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Summary}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Differential Dynamic Programming provides a principled temporal decomposition framework for large-scale MPOPF problems. By reformulating MPOPF as an optimal control problem with battery SOC as states, DDP achieves:

\begin{itemize}
    \item \textbf{Linear time complexity} $\mathcal{O}(N)$ in horizon length $N$
    \item \textbf{Natural handling} of nonlinear branch flow models (BFM-NL) without approximation
    \item \textbf{Sequential structure} exploiting causal battery dynamics
    \item \textbf{Warm-start capability} for rolling-horizon MPC implementations
\end{itemize}

The key insight is that battery SOC couples time periods, while power flow constraints decouple across time. DDP leverages this structure by solving backward-forward passes, where:
\begin{itemize}
    \item \textbf{Backward pass}: Computes optimal feedback policy (how battery should react to SOC deviations)
    \item \textbf{Forward pass}: Rolls out trajectory respecting power flow constraints at each time step
\end{itemize}

While DDP demonstrates strong theoretical properties for nonlinear optimal control, its practical performance for MPOPF depends on:
\begin{enumerate}
    \item Quality of initialization (warm start from previous solution or LinDistFlow approximation)
    \item Constraint handling method (projection onto feasible set most effective)
    \item Regularization tuning (ensuring $Q_{uu}$ invertibility without over-damping)
\end{enumerate}

The next chapter explores an alternative temporal decomposition approach based on ADMM consensus, which trades off the Markov exploitation of DDP for greater parallelizability and convex convergence guarantees.
