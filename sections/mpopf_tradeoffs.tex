%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% Chapter: MPOPF Modelling Tradeoffs - Linear vs Nonlinear
% Context: Analysis of formulation choices before decomposition
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{MPOPF Modelling Tradeoffs: Linear vs Nonlinear Formulations}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Introduction and Motivation}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

As discussed in the previous chapters, multi-period optimal power flow (MPOPF) problems are essential for managing grid edge devices (GEDs) such as battery energy storage systems (BESS) and photovoltaic (PV) systems in modern electricity distribution networks (EDNs). The subsequent chapters of this report will focus on spatial and temporal decomposition techniques to make MPOPF computationally tractable for large-scale systems. However, \textit{before} attempting any decomposition strategy, a fundamental question arises: \textbf{What formulation should be used to model the underlying power flow equations?}

This chapter addresses this critical question by comparing two widely-used MPOPF formulations:
\begin{enumerate}
    \item \textbf{Nonlinear Branch Flow Model (BFM-NL)}: Based on the original branch flow equations \cite{Farivar1}, this formulation yields a non-convex programming (NCP) problem that captures network losses and voltage-current relationships accurately but suffers from slow convergence.
    \item \textbf{Linear Programming (LinDistFlow)}: Based on the LinDistFlow approximation \cite{Gan}, this formulation simplifies the power flow equations into a linear program (LP) that converges rapidly but introduces an optimality gap by neglecting certain nonlinear terms.
\end{enumerate}

The choice between these formulations has profound implications for decomposition algorithms. A poor initial formulation can lead to:
\begin{itemize}
    \item Sub-optimal solutions even if the decomposition converges correctly
    \item Physically infeasible control set-points when validated through AC power flow
    \item Misleading reactive power dispatch strategies
    \item Inaccurate predictions of critical quantities like substation power and line losses
\end{itemize}

\textbf{Research Gap:} While previous work has explored both NCP \cite{Gabash, Safdarian, Jha} and LP-based \cite{Li, Lei, spaul, Yang, Vaishya} OPF methods, no comprehensive study has investigated how EDN size and GED penetration levels systematically affect the optimality gap and feasibility of linear approximations compared to nonlinear formulations.

\textbf{Contribution:} This chapter provides a systematic comparison of BFM-NL and LinDistFlow formulations across three test systems of varying scales and GED penetrations. The analysis reveals when linear approximations are acceptable and when they introduce critical errorsâ€”insights that directly inform the decomposition strategies presented in subsequent chapters.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Problem Formulation: BFM-NL vs LinDistFlow}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Notations}
The distribution system is modeled as a tree (connected graph) with $\mathcal{N}$ representing the set of all buses (indexed with \(i\), \(j\), and \(k\)). A directed edge from bus $i$ to $j$ is represented by $ij$ and the set of edges is $\mathcal{L}$. Line resistance and reactance are \(r_{ij}\) and \(x_{ij}\), respectively. The study is conducted for a horizon of $T$ time steps, each of interval length $\Delta t$, with $\tau = \{1, 2, \ldots T\}$ representing the set of all time-steps. The set of buses with PVs is $\mathcal{D}$ and with batteries is $\mathcal{B}$, where $\mathcal{D}, \mathcal{B} \subseteq \mathcal{N_L}$ and $\mathcal{N_L}$ denotes the set of all load buses.

Key variables include:
\begin{itemize}
    \item \(V_j^t\): voltage magnitude at bus \(j\) at time \(t\), with \(v_j^t = (V_j^t)^2\)
    \item \(I_{ij}^t\): current magnitude through line \(ij\) at time \(t\), with \(l_{ij}^t = (I_{ij}^t)^2\)
    \item \(P_{ij}^t, Q_{ij}^t\): real and reactive power flow through line \(ij\) at time \(t\)
    \item \(p^t_{L_j}, q^t_{L_j}\): real and reactive load demand at bus \(j\) at time \(t\)
    \item \(p^t_{D_j}, q^t_{D_j}\): real and reactive power from PV inverter at bus \(j\) at time \(t\)
    \item \(P_{c_j}^t, P_{d_j}^t\): battery charging and discharging power at bus \(j\) at time \(t\)
    \item \(q_{B_j}^t\): reactive power support from battery inverter at bus \(j\) at time \(t\)
    \item \(B_j^t\): battery energy level at bus \(j\) at time \(t\)
    \item \(P^t_{Subs}\): real power from substation at time \(t\)
    \item \(C^t\): cost per kWh of substation power at time \(t\)
\end{itemize}

Inverter and battery parameters:
\begin{itemize}
    \item \(S_{D_{R_j}}, S_{B_{R_j}}\): apparent power capacity of PV and battery inverters
    \item \(P_{B_{R_j}}, B_{R_j}\): rated power and energy capacity of battery
    \item \(\eta_c, \eta_d\): charging and discharging efficiencies
    \item \(soc_{min}, soc_{max}\): safe state-of-charge limits (fractional)
\end{itemize}

\subsubsection{Objective Function}

The MPOPF objective is to minimize the total cost of substation power over the horizon, with a secondary penalty to prevent simultaneous charging and discharging (SCD) of batteries \cite{Nazir2021Sep}:

\begin{align}
    \min \sum_{t = 1}^{T} \left\{ f_0^t + f_{SCD}^t \right\}
    \label{eq:mpopf-tradeoffs-objective}
\end{align}

where

\begin{align}
    f_0^t &= C^t P^t_{Subs} \Delta t \nonumber \\
    f_{SCD}^t &= \alpha \sum_{j \in \mathcal{B}} \left\{ (1-\eta_c)P^t_{c_j} + \left( \frac{1}{\eta_d} - 1 \right) P^t_{d_j} \right\} \nonumber
\end{align}

The hyperparameter $\alpha$ is tuned to ensure SCD is avoided for the given system configuration.

\subsubsection{Constraints: Side-by-Side Comparison}

The key difference between BFM-NL and LinDistFlow lies in the power flow equations. \Cref{table:mpopf-constraint-comparison} provides a side-by-side comparison of the main constraints.

\begin{table}[t]
    \centering
    \caption{Constraint comparison: BFM-NL vs LinDistFlow}
    \label{table:mpopf-constraint-comparison}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Constraint Type} & \textbf{BFM-NL} & \textbf{LinDistFlow} \\ \hline
    Real power balance & Includes \(r_{ij}l_{ij}^t\) loss & Neglects loss \\ \hline
    Reactive power balance & Includes \(x_{ij}l_{ij}^t\) loss & Neglects loss \\ \hline
    Voltage drop (KVL) & Includes \((r_{ij}^2 + x_{ij}^2)l_{ij}^t\) & Neglects term \\ \hline
    Apparent power & Quadratic: \((P_{ij}^t)^2 + (Q_{ij}^t)^2 = l_{ij}^t v_i^t\) & Not modeled \\ \hline
    Battery reactive power & Quadratic: \((P_{B_j}^t)^2 + (q_{B_j}^t)^2 \leq S_{B_{R,j}}^2\) & Hexagonal approx. \\ \hline
    \end{tabular}
\end{table}

\paragraph{Power Balance Equations:}

\textbf{Real Power (BFM-NL):}
\begin{align}
    {\sum_{(j, k) \in \mathcal{L}} P_{jk}^t - \left(P_{ij}^t - r_{ij}l_{ij}^t\right)} &= p_j^t
    \label{eq:mpopf-tradeoffs-real-balance-nl}
\end{align}

\textbf{Real Power (LinDistFlow):}
\begin{align}
    {\sum_{(j, k) \in \mathcal{L}} P_{jk}^t - P_{ij}^t} &= p_j^t
    \label{eq:mpopf-tradeoffs-real-balance-l}
\end{align}

where \(p_j^t = (P_{d_j}^t - P_{c_j}^t) + p^t_{D_j} - p^t_{L_j}\)

\textbf{Reactive Power (BFM-NL):}
\begin{align}
    {\sum_{(j, k) \in \mathcal{L}} Q_{jk}^t - \left(Q_{ij}^t - x_{ij}l_{ij}^t\right)} &= q_j^t
    \label{eq:mpopf-tradeoffs-reactive-balance-nl}
\end{align}

\textbf{Reactive Power (LinDistFlow):}
\begin{align}
    {\sum_{(j, k) \in \mathcal{L}} Q_{jk}^t - Q_{ij}^t} &= q_j^t
    \label{eq:mpopf-tradeoffs-reactive-balance-l}
\end{align}

where \(q_j^t = q_{D_j}^t + q_{B_j}^t - q^t_{L_j}\)

\paragraph{Voltage Drop (KVL):}

\textbf{BFM-NL:}
\begin{align}
    {v_j^t} &= {v_{i}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t) + (r_{ij}^2 + x_{ij}^2)l_{ij}^t}  
    \label{eq:mpopf-tradeoffs-kvl-nl}
\end{align}

\textbf{LinDistFlow:}
\begin{align}
    {v_j^t} &= {v_{i}^t - 2(r_{ij}P_{ij}^t + x_{ij}Q_{ij}^t) }  
    \label{eq:mpopf-tradeoffs-kvl-l}
\end{align}

\paragraph{Apparent Power and Current (BFM-NL only):}
\begin{align}
    {(P_{ij}^{t})^2 + (Q_{ij}^{t})^2} &= {l_{ij}^t v_i^t} 
    \label{eq:mpopf-tradeoffs-apparent-power}
\end{align}

\paragraph{Common Constraints:}

The following constraints are identical for both formulations:

\begin{align}
    {P^t_{Subs}} &\geq {0} \label{eq:mpopf-tradeoffs-subs-power} \\
    { v^{t}_{j} } &\in { [V^{2}_{min}, V^{2}_{max}] } \label{eq:mpopf-tradeoffs-voltage-limits} \\
    { q^{t}_{D_{j}} } &\in { [-q_{D_{Max, j}}^{t}, q_{D_{Max, j}}^{t}] }, \quad q_{D_{Max, j}}^{t} = \sqrt{ {S_{D_{R, j}}}^2 - {p^{t}_{D_{j}}}^2} \label{eq:mpopf-tradeoffs-pv-reactive} \\
    {B_{j}^{t}} &= {B_{j}^{t-1} + \Delta t ( \eta_c P_{c_j}^t - \frac{1}{\eta_d} P_{d_j}^t )  } \label{eq:mpopf-tradeoffs-soc-trajectory} \\
    { P^{t}_{c_{j}}, P^{t}_{d_{j}} } &\in { [0, P_{B_{R, j}} ]} \label{eq:mpopf-tradeoffs-battery-power-limits} \\
    { B^{t}_{j} } &\in { [soc_{min}B_{R, j}, soc_{max}B_{R, j}] } \label{eq:mpopf-tradeoffs-soc-limits}
\end{align}

\paragraph{Battery Inverter Reactive Power:}

\textbf{BFM-NL (Quadratic):}
\begin{align}
    {(P_{B_j}^t)^2 + (q_{B_j}^t)^2} &\leq {S_{B_{R, j}}^2}, \quad P_{B_j}^t = P_{d_j}^t - P_{c_j}^t
    \label{eq:mpopf-tradeoffs-battery-reactive-nl}
\end{align}

\textbf{LinDistFlow (Hexagonal Approximation \cite{Ahmadi2014Oct}):}
\begin{subequations}
    \label{eq:mpopf-tradeoffs-battery-reactive-l}
    \begin{align}
        q_{B_j}^t &\in [-\sqrt{3} (P_{B_j}^t + S_{B_{R, j}}), -\sqrt{3} (P_{B_j}^t - S_{B_{R, j}})]  \\
        q_{B_j}^t &\in [-\frac{\sqrt{3}}{2} S_{B_{R, j}}, \frac{\sqrt{3}}{2} S_{B_{R, j}}] \\
        q_{B_j}^t &\in [\sqrt{3} (P_{B_j}^t - S_{B_{R, j}}), \sqrt{3} (P_{B_j}^t + S_{B_{R, j}})] 
    \end{align}
\end{subequations}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Test Systems and Simulation Setup}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\subsubsection{Test Systems}

Three test systems of varying scales and GED penetrations were evaluated:

\begin{enumerate}
    \item \textbf{ADS10}: A small 10-bus Active Distribution System (\Cref{fig:mpopf-tradeoffs-ads10}) with 25\% PV and 25\% battery penetration. Each GED's active power rating is 33\% of the rated load power at the respective bus.
    
    \item \textbf{IEEE123A}: The IEEE 123-bus test system (\Cref{fig:mpopf-tradeoffs-ieee123}) with moderate GED penetrationâ€”20\% of load buses have PVs and 30\% have batteries. Each GED's active power rating is 33\% of the rated load power.
    
    \item \textbf{IEEE123B}: The IEEE 123-bus system with high GED penetrationâ€”30\% of load buses have PVs and 50\% have batteries. Each GED's active power rating is 100\% of the rated load power.
\end{enumerate}

\begin{figure}[t]
    \centering
    \includegraphics[width=0.75\linewidth]{figures/ads10-pv25-batt25.png}
    \caption{ADS10 test system with 25\% PV and 25\% BESS penetration}
    \label{fig:mpopf-tradeoffs-ads10}
\end{figure}

\begin{figure}[t]
    \centering
    \includegraphics[width=\linewidth]{figures/ieee123-pv20-batt30.png}
    \caption{IEEE-123 test system with 20\% PV and 30\% BESS penetration (IEEE123A configuration)}
    \label{fig:mpopf-tradeoffs-ieee123}
\end{figure}

\Cref{table:mpopf-tradeoffs-system-config} summarizes the configurations, where $n, n_L, n_D, n_B$ are the cardinalities of sets $\mathcal{N}, \mathcal{N_L}, \mathcal{D}, \mathcal{B}$ respectively, and $\alpha$ is the SCD penalty hyperparameter from \cref{eq:mpopf-tradeoffs-objective}.

\begin{table}[t]
    \centering
    \caption{Test system configurations}
    \label{table:mpopf-tradeoffs-system-config}
    \begin{tabular}{|l|c|c|c|}
    \hline
    \textbf{Parameter} & \textbf{ADS10} & \textbf{IEEE123A} & \textbf{IEEE123B} \\ \hline
    $n$ & 10 & 128 & 128 \\ \hline
    $n_{L}$ & 8 & 85 & 85 \\ \hline
    $n_{D}$ & 2 & 17 & 26 \\ \hline
    $n_{B}$ & 2 & 34 & 43 \\ \hline
    $p_{D_{R,j}}$ & $0.33 \, p_{L_{R,j}}$ & $0.33 \, p_{L_{R,j}}$ & $1.00 \, p_{L_{R,j}}$ \\ \hline
    $p_{B_{R,j}}$ & $0.33 \, p_{L_{R,j}}$ & $0.33 \, p_{L_{R,j}}$ & $1.00 \, p_{L_{R,j}}$ \\ \hline
    $\alpha$ & 12.62 & 8.994 & 2.124 \\ \hline
    \end{tabular}
\end{table}

Common parameter values across all systems are given in \Cref{table:mpopf-tradeoffs-parameters}.

\begin{table}[t]
    \centering
    \caption{Common parameter values}
    \label{table:mpopf-tradeoffs-parameters}
    \begin{tabular}{|l|c|}
    \hline
    \textbf{Parameter} & \textbf{Value} \\ \hline
    $V_{min}, V_{max}$ & 0.95\, pu, 1.05\, pu \\ \hline
    $S_{D_{R,j}}$ & $1.2 \, p_{D_{R,j}}$ \\ \hline
    $S_{B_{R,j}}$ & $1.2 \, P_{B_{R,j}}$ \\ \hline
    $B_{R,j}$ & $T_{fullCharge} \times P_{B_{R,j}}$ \\ \hline
    $T_{fullCharge}$ & 4\,h \\ \hline
    $T$ & 24 \\ \hline
    $\Delta t$ & 1\,h \\ \hline
    $\eta_c, \eta_d$ & 0.95, 0.95 \\ \hline
    $soc_{min}, soc_{max}$ & 0.30, 0.95 \\ \hline
    \end{tabular}
\end{table}

\subsubsection{Input Forecast Curves}

All systems use the same 24-hour forecast curves for load demand, PV irradiance, and time-varying electricity costs, as shown in \Cref{fig:mpopf-tradeoffs-input-curves}. The bilevel cost structure represents typical day-ahead pricing with peak and off-peak periods.

\begin{figure}[t]
    \centering
    \includegraphics[height=0.25\textheight]{figures/T24-inputCurves/Horizon_24_InputForecastCurves_bilevelCosts.png}
    \caption{Forecasts for demand power, irradiance, and cost of substation power over a 24-hour horizon}
    \label{fig:mpopf-tradeoffs-input-curves}
\end{figure}

\subsubsection{Simulation Workflow}

The optimization problems were modeled in Julia using the JuMP package \cite{Lubin2023} and solved with the Ipopt solver \cite{ipopt-solver-Wachter2006Mar}. Validation was performed using OpenDSS via the OpenDSSDirect.jl package \cite{OpenDSSDirect-jl}.

For each test system:
\begin{enumerate}
    \item Parse system topology and GED configuration from `.dss' files
    \item Apply common forecast curves from \Cref{fig:mpopf-tradeoffs-input-curves}
    \item Convert to JuMP models representing 24-hour day-ahead planning
    \item Solve with Ipopt to obtain optimal control variables: \(P_{c_j}^t, P_{d_j}^t, q_{B_j}^t \, \forall j \in \mathcal{B}\) and \(q_{D_j}^t \, \forall j \in \mathcal{D}\), \(\forall t \in \tau\)
    \item Feed control set-points into OpenDSS (preconfigured with same `.dss' files)
    \item Compare OpenDSS results (state and output variables) against optimization results to check for infeasibilities
\end{enumerate}

\textbf{Important Note:} For LinDistFlow, the reported results use OpenDSS outputs when fed with LinDistFlow control variables. This is because LinDistFlow, by design, does not account for network losses, leading to underestimated values of \(P_{Subs}^t\) and line losses. This conjunction is denoted by LinDistFlow\textsuperscript{\(\mathbb{O}\)} in the results tables. The complete code is available in \cite{MPOPFRepo}.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Results and Performance Analysis}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

Results are presented in two sets of tables per test system:
\begin{enumerate}
    \item \textbf{Optimality Tables} (\Cref{table:mpopf-tradeoffs-opt-ads10,table:mpopf-tradeoffs-opt-ieee123a,table:mpopf-tradeoffs-opt-ieee123b}): Direct performance comparison highlighting optimization metrics (substation cost, power, losses, computation time)
    \item \textbf{Feasibility Tables} (\Cref{table:mpopf-tradeoffs-feas-ads10,table:mpopf-tradeoffs-feas-ieee123a,table:mpopf-tradeoffs-feas-ieee123b}): Validation via OpenDSS quantifying discrepancies in state/output variables
\end{enumerate}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{ADS10 Results}

\begin{table}[H]
    \centering
    \caption{MPOPF performance comparison - ADS10 test system for 24h}
    \label{table:mpopf-tradeoffs-opt-ads10}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Metric} & \textbf{BFM-NL} & \textbf{LinDistFlow\textsuperscript{\(\mathbb{O}\)}} \\ \hline
    \multicolumn{3}{|c|}{\textit{Full horizon}} \\ \hline
    Substation power cost (\$) & 204.27 & 204.28 \\ \hline
    Substation real power (kWh) & 1528.35 & 1528.4 \\ \hline
    Line loss (kWh) & 0.28 & 0.33 \\ \hline
    Substation reactive power (kVARh) & 428.9 & 795.56 \\ \hline
    PV reactive power (kVARh) & 174.41 & -0.69 \\ \hline
    Battery reactive power (kVARh) & 192.8 & -0.37 \\ \hline
    \multicolumn{3}{|c|}{\textit{Computation}} \\ \hline
    Total simulation time (s) & 2.64 & 0.77 \\ \hline
    \end{tabular}
\end{table}

\begin{table}[H]
    \centering
    \caption{MPOPF discrepancy comparison - ADS10 test system for 24h}
    \label{table:mpopf-tradeoffs-feas-ads10}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Metric} & \textbf{BFM-NL} & \textbf{LinDistFlow} \\ \hline
    \multicolumn{3}{|c|}{\textit{Max. all-time discrepancy}} \\ \hline
    Voltage (pu) & 0.00001 & 0.00001 \\ \hline
    Line loss (kW) & 0.000009 & 0.000006 \\ \hline
    Substation power (kW) & 0.000014 & 0.02410 \\ \hline
    Substation reactive power (kVAR) & 0.070706 & 0.05618 \\ \hline
    \end{tabular}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{IEEE123A Results}

\begin{table}[H]
    \centering
    \caption{MPOPF performance comparison - IEEE123-A test system for 24h}
    \label{table:mpopf-tradeoffs-opt-ieee123a}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Metric} & \textbf{BFM-NL} & \textbf{LinDistFlow\textsuperscript{\(\mathbb{O}\)}} \\ \hline
    \multicolumn{3}{|c|}{\textit{Model dimensions}} \\ \hline
    Decision variables & {15144} & {12096} \\ \hline
    Linear constraints & {18456} & {22200} \\ \hline
    Nonlinear constraints & {3672} & {0} \\ \hline
    \multicolumn{3}{|c|}{\textit{Simulation results}} \\ \hline
    Substation power cost (\$) & 2787.44 & 2798.4 \\ \hline
    Substation real power (kWh) & 20984.89 & 21065.89 \\ \hline
    Line loss (kWh) & 380.09 & 461.38 \\ \hline
    Substation reactive power (kVARh) & 6835.82 & 12259.29 \\ \hline
    PV reactive power (kVARh) & 1972.27 & 195.12 \\ \hline
    Battery reactive power (kVARh) & 3709.71 & 204.63 \\ \hline
    \multicolumn{3}{|c|}{\textit{Computation}} \\ \hline
    Total simulation time (s) & 17.44 & 0.85 \\ \hline
    \end{tabular}
\end{table}

\begin{table}[H]
    \centering
    \caption{MPOPF discrepancy comparison - IEEE123-A test system for 24h}
    \label{table:mpopf-tradeoffs-feas-ieee123a}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Metric} & \textbf{BFM-NL} & \textbf{LinDistFlow} \\ \hline
    \multicolumn{3}{|c|}{\textit{Max. all-time discrepancy}} \\ \hline
    Voltage (pu) & 0.00007 & 0.00206 \\ \hline
    Line loss (kW) & 0.01818 & 1.8074 \\ \hline
    Substation power (kW) & 0.43164 & 32.362 \\ \hline
    Substation reactive power (kVAR) & 1.0102 & 64.403 \\ \hline
    \end{tabular}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{IEEE123B Results}

\begin{table}[H]
    \centering
    \caption{MPOPF performance comparison - IEEE123-B test system for 24h}
    \label{table:mpopf-tradeoffs-opt-ieee123b}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Metric} & \textbf{BFM-NL} & \textbf{LinDistFlow\textsuperscript{\(\mathbb{O}\)}} \\ \hline
    \multicolumn{3}{|c|}{\textit{Model dimensions}} \\ \hline
    Decision variables & {17184} & {14136} \\ \hline
    Linear constraints & {24168} & {30360} \\ \hline
    Nonlinear constraints & {4080} & {0} \\ \hline
    \multicolumn{3}{|c|}{\textit{Simulation results}} \\ \hline
    Substation power cost (\$) & 1973.83 & 1987.78 \\ \hline
    Substation real power (kWh) & 16594.11 & 16693.01 \\ \hline
    Line loss (kWh) & 234.78 & 333.78 \\ \hline
    Substation reactive power (kVARh) & -404.91 & 11055.41 \\ \hline
    PV reactive power (kVARh) & 7255.22 & 1535.29 \\ \hline
    Battery reactive power (kVARh) & 5371.97 & -190.93 \\ \hline
    \multicolumn{3}{|c|}{\textit{Computation}} \\ \hline
    Total simulation time (s) & 23.75 & 1.66 \\ \hline
    \end{tabular}
\end{table}

\begin{table}[H]
    \centering
    \caption{MPOPF discrepancy comparison - IEEE123-B test system for 24h}
    \label{table:mpopf-tradeoffs-feas-ieee123b}
    \begin{tabular}{|l|c|c|}
    \hline
    \textbf{Metric} & \textbf{BFM-NL} & \textbf{LinDistFlow} \\ \hline
    \multicolumn{3}{|c|}{\textit{Max. all-time discrepancy}} \\ \hline
    Voltage (pu) & 0.000059 & 0.001599 \\ \hline
    Line loss (kW) & 0.00776 & 1.055093 \\ \hline
    Substation power (kW) & 0.217433 & 23.344019 \\ \hline
    Substation reactive power (kVAR) & 1.016894 & 45.925288 \\ \hline
    \end{tabular}
\end{table}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Discussion: Key Insights for Decomposition Algorithms}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

This section synthesizes the simulation results to highlight critical insights that directly inform the choice of formulation for spatial and temporal decomposition algorithms presented in subsequent chapters.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Computational Speedup}

As expected, the LinDistFlow model significantly outperforms BFM-NL in computation time, achieving speedups of approximately \textbf{3Ã—, 20Ã—, and 14Ã—} for ADS10, IEEE123A, and IEEE123B systems respectively. This performance gain stems primarily from the elimination of nonlinear constraints (\cref{table:mpopf-tradeoffs-opt-ieee123a,table:mpopf-tradeoffs-opt-ieee123b} show zero nonlinear constraints for LinDistFlow).

Although LinDistFlow may include more total constraints (all linear) than BFM-NL's combination of linear and nonlinear ones, solve times remain dominated by the elimination of nonlinearity. Modern LP solvers handle large numbers of linear constraints efficiently, whereas nonlinear solvers must iteratively navigate non-convex landscapes.

\textbf{Note:} All BFM-NL timings assume a cold start. Warm-starting BFM-NL with LinDistFlow solutions would likely narrow the computational gap furtherâ€”a strategy worth considering for decomposition algorithms where subproblems are solved repeatedly.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Optimality Gap: The Core Tradeoff}

Since the objective function is the cost of total substation power borrowed over the horizon (\(f_0 = \sum_{t=1}^{T} C^t P^t_{Subs} \Delta t\) from \cref{eq:mpopf-tradeoffs-objective}), we quantify the optimality gap as:

\[
\text{Optimality Gap} = \frac{f_{\text{LinDistFlow}} - f_{\text{BFM-NL}}}{f_{\text{BFM-NL}}} \times 100\%
\]

Computing from \cref{table:mpopf-tradeoffs-opt-ads10,table:mpopf-tradeoffs-opt-ieee123a,table:mpopf-tradeoffs-opt-ieee123b}:
\begin{itemize}
    \item \textbf{ADS10}: Gap = 0.005\% (essentially negligible)
    \item \textbf{IEEE123A}: Gap = 0.39\% (acceptable for many applications)
    \item \textbf{IEEE123B}: Gap = 0.71\% (caution required)
\end{itemize}

\textbf{Analysis:} The optimality gap grows with both system size and GED penetration. Two primary factors explain this trend:

\begin{enumerate}
    \item \textbf{Line Loss Approximation}: Larger systems experience greater line losses. LinDistFlow neglects the \((r_{ij}^2 + x_{ij}^2)l_{ij}^t\) term in the KVL equation (\cref{eq:mpopf-tradeoffs-kvl-l} vs \cref{eq:mpopf-tradeoffs-kvl-nl}) and the loss terms in power balance equations (\cref{eq:mpopf-tradeoffs-real-balance-l,eq:mpopf-tradeoffs-reactive-balance-l} vs \cref{eq:mpopf-tradeoffs-real-balance-nl,eq:mpopf-tradeoffs-reactive-balance-nl}). As losses increase, this approximation error compounds.
    
    \item \textbf{Battery Inverter Reactive Power Model}: Higher battery penetration amplifies errors from the hexagonal approximation (\cref{eq:mpopf-tradeoffs-battery-reactive-l}) compared to the true quadratic constraint (\cref{eq:mpopf-tradeoffs-battery-reactive-nl}). This is especially pronounced in IEEE123B where battery ratings equal load ratings (100\% penetration).
\end{enumerate}

\textbf{Implication for Decomposition:} When developing spatial or temporal decomposition algorithms (Chapters~\ref{sec:enapp} and~\ref{sec:tadmm}), using LinDistFlow as the base formulation will propagate this optimality gap. For large-scale systems or high DER penetrations, this gap may be unacceptable. However, for moderate-sized systems with lower penetrations, the computational speedup may justify the small optimality sacrifice.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Reactive Power Control: A Critical Discrepancy}

One of the most striking differences between the two formulations is their reactive power management strategy, as seen in the ``PV reactive power'' and ``Battery reactive power'' rows of \cref{table:mpopf-tradeoffs-opt-ads10,table:mpopf-tradeoffs-opt-ieee123a,table:mpopf-tradeoffs-opt-ieee123b}.

\textbf{BFM-NL Behavior:} Deliberately allocates reactive power among PV inverters, batteries, and the substation based on:
\begin{itemize}
    \item Network losses (via the \(l_{ij}^t x_{ij}\) term in \cref{eq:mpopf-tradeoffs-reactive-balance-nl})
    \item Device capabilities and locations
    \item Voltage sensitivity at each bus
\end{itemize}

For example, in IEEE123A (moderate GED penetration), BFM-NL assigns:
\begin{itemize}
    \item 1972 kVARh to PV inverters
    \item 3710 kVARh to battery inverters
    \item 6836 kVARh from substation
\end{itemize}

\textbf{LinDistFlow Behavior:} By dropping the \(l_{ij}^t x_{ij}\) term (\cref{eq:mpopf-tradeoffs-reactive-balance-l}), LinDistFlow loses sensitivity to how reactive power dispatch affects line losses. Consequently, it assigns reactive power in an almost arbitrary mannerâ€”often defaulting most reactive support to the substation:
\begin{itemize}
    \item 195 kVARh to PV inverters (10Ã— less than BFM-NL)
    \item 205 kVARh to battery inverters (18Ã— less than BFM-NL)
    \item 12259 kVARh from substation (1.8Ã— more than BFM-NL)
\end{itemize}

\textbf{Practical Consequences:}
\begin{enumerate}
    \item \textbf{Under-utilization of Distributed Assets}: LinDistFlow fails to leverage the reactive power capability of distributed inverters, missing opportunities for localized voltage support and loss reduction.
    
    \item \textbf{Substation Overload Risk}: Concentrating reactive power at the substation may violate transformer ratings or lead to inefficient operation.
    
    \item \textbf{Voltage Profile Degradation}: While both models achieve similar substation costs, LinDistFlow's coarse reactive dispatch risks larger voltage deviations throughout the network, especially during contingencies.
    
    \item \textbf{Missed Grid Support Opportunities}: Modern grid codes increasingly require DERs to provide reactive support. LinDistFlow-based control strategies would systematically under-utilize this capability.
\end{enumerate}

\textbf{Implication for Decomposition:} If the objective function includes voltage regulation, reactive power costs, or inverter utilization penalties (beyond simple substation cost minimization), LinDistFlow-based decomposition algorithms will produce fundamentally flawed solutions. Even for cost-minimization objectives, the reactive power mismatch creates operational risks that may be unacceptable in practice.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Voltage and Power Feasibility}

\Cref{table:mpopf-tradeoffs-feas-ads10,table:mpopf-tradeoffs-feas-ieee123a,table:mpopf-tradeoffs-feas-ieee123b} quantify discrepancies when control set-points from each model are applied in OpenDSS. These are computed as:

\[
\text{Disc}_v = \max_{j \in \mathcal{N}, t \in \tau} |V^t_{j,\text{OpenDSS}} - V^t_{j,\text{model}}|
\]
\[
\text{Disc}_{P_{Subs}} = \max_{t \in \tau} |P^t_{Subs,\text{OpenDSS}} - P^t_{Subs,\text{model}}|
\]

\textbf{Voltage Deviation:} LinDistFlow maintains voltage errors under \textbf{0.2\%} compared to BFM-NL (which itself has negligible errors). For most distribution operations, this is acceptable and unlikely to cause voltage limit violations.

\textbf{Substation Power Underprediction:} This is the critical concern. LinDistFlow can under-predict hourly substation power by up to \textbf{2--5\%} (24--32 kW for IEEE123A, which represents hundreds of kWh over the horizon). This creates three operational risks:

\begin{enumerate}
    \item \textbf{Equipment Limit Violations}: If the actual substation draw approaches transformer ratings, LinDistFlow's underestimation may lead to overloads.
    
    \item \textbf{Reserve Margin Errors}: System operators rely on accurate power predictions to maintain adequate reserves. A 5\% error can compromise reliability during contingencies.
    
    \item \textbf{Economic Inaccuracies}: In real-time markets, substation power ties directly to settlement costs. Systematic underprediction leads to unexpected charges and missed arbitrage opportunities.
\end{enumerate}

\textbf{Implication for Decomposition:} When using LinDistFlow-based decomposition, the subproblem solutions will consistently underestimate substation power and line losses. Aggregating these errors across spatial regions or temporal windows can produce dangerously optimistic predictions. Post-processing corrections or warm-starting with LinDistFlow followed by BFM-NL refinement becomes essential.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsubsection{Complementary Modeling Strategy: A Hybrid Approach}

Based on the above analysis, a purely LinDistFlow-based or purely BFM-NL-based approach each has critical limitations:

\textbf{LinDistFlow Strengths:}
\begin{itemize}
    \item Fast convergence (10--20Ã— speedup)
    \item Near-optimal cost objective (within 0.4--0.7\% for moderate systems)
    \item Suitable for rapid scenario screening or initialization
\end{itemize}

\textbf{LinDistFlow Weaknesses:}
\begin{itemize}
    \item Under-reports substation power and line losses
    \item Arbitrary reactive power allocation
    \item Optimality gap grows with system size and GED penetration
\end{itemize}

\textbf{BFM-NL Strengths:}
\begin{itemize}
    \item Accurate physics representation
    \item Physically consistent control and state variables
    \item Intelligent reactive power dispatch
\end{itemize}

\textbf{BFM-NL Weaknesses:}
\begin{itemize}
    \item Slow convergence (especially for cold starts)
    \item May struggle with large-scale systems without decomposition
\end{itemize}

\paragraph{Recommended Hybrid Strategy:}

For the spatial and temporal decomposition algorithms developed in subsequent chapters, we recommend:

\begin{enumerate}
    \item \textbf{Phase 1 (Initialization)}: Solve the MPOPF problem using LinDistFlow to quickly obtain near-optimal control set-points. Use these to warm-start the subsequent phase.
    
    \item \textbf{Phase 2 (Refinement)}: Solve the MPOPF problem using BFM-NL, initialized with Phase 1 results. This captures accurate physics while benefiting from the warm start to reduce computation time.
    
    \item \textbf{Phase 3 (Validation)}: Always validate final control set-points through OpenDSS or another AC power flow solver before deployment.
\end{enumerate}

This hybrid approach provides a \textbf{feasible and optimal solution suitable for real-time operations} while maintaining computational tractability. The spatial decomposition (ENApp) and temporal decomposition (ADMM) algorithms presented in the following chapters can incorporate either formulation or this hybrid strategy depending on the application requirements.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\subsection{Conclusions and Implications}

This chapter has demonstrated that the choice of power flow formulationâ€”before any decomposition is attemptedâ€”has profound implications for solution quality, computational efficiency, and operational feasibility. The key findings are:

\begin{enumerate}
    \item \textbf{Optimality Gap}: LinDistFlow introduces a gap that grows from 0.005\% (small systems) to 0.7\% (large systems with high GED penetration). While acceptable for cost minimization in moderate-sized systems, this gap may be unacceptable for large-scale deployments.
    
    \item \textbf{Reactive Power Mismanagement}: LinDistFlow systematically under-utilizes distributed inverter assets, concentrating reactive power at the substation. This creates operational risks and misses grid support opportunities.
    
    \item \textbf{Substation Power Underprediction}: LinDistFlow can underestimate hourly substation power by up to 5\%, risking equipment overloads, reserve margin violations, and economic inaccuracies.
    
    \item \textbf{Computational Speedup}: LinDistFlow achieves 10--20Ã— faster solve times by eliminating nonlinear constraints, making it attractive for rapid scenario analysis or warm-start initialization.
\end{enumerate}

\textbf{Central Insight:} \textit{The formulation you choose fundamentally shapes the behavior of any decomposition algorithm built on top of it.} A spatially or temporally decomposed MPOPF using LinDistFlow will inherit its reactive power mismanagement and substation power errors, even if the decomposition itself converges correctly. Conversely, a decomposed BFM-NL approach will be more computationally expensive but will produce physically consistent and operationally sound solutions.

\textbf{Forward Connection:} The subsequent chapters develop:
\begin{itemize}
    \item \textbf{Chapter on Spatial Decomposition (ENApp)}: A spatially distributed MPOPF algorithm that partitions the network into areas. The insights from this chapter inform whether to use BFM-NL, LinDistFlow, or a hybrid approach for the area subproblems.
    
    \item \textbf{Chapter on Temporal Decomposition (tADMM)}: An ADMM-based temporal decomposition that breaks the multi-period problem into single-period subproblems. The formulation choice (BFM-NL vs LinDistFlow) directly affects convergence behavior and solution quality.
\end{itemize}

By carefully considering the tradeoffs analyzed in this chapter, the decomposition algorithms can be designed to balance computational efficiency with solution accuracy, ultimately enabling scalable and reliable MPOPF for modern distribution networks with high penetrations of grid edge devices.
